<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê°€ë°©ëˆ ê¸¸ì´ ì¶”ì²œê¸°</title>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Pretendard', sans-serif;
      background: #f0f4f8;
      color: #333;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    video {
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 1rem;
    }
    button {
      width: 100%;
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    button:hover {
      background-color: #1d4ed8;
    }
    .result {
      margin-top: 1rem;
      background: #e0f2fe;
      padding: 1rem;
      border-radius: 8px;
      font-size: 1.2rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>ğŸ’ ê°€ë°©ëˆ ê¸¸ì´ ì¶”ì²œê¸°</h1>
  <video id="video" autoplay playsinline></video>

  <label>í‚¤ (cm)</label>
  <input type="number" id="height" value="170">

  <label>ëª¸ë¬´ê²Œ (kg)</label>
  <input type="number" id="weight" value="60">

  <label>ê°€ë°© ë¬´ê²Œ (kg)</label>
  <input type="number" id="bagWeight" value="3">

  <button onclick="analyze()">ìì„¸ ë¶„ì„ & ëˆ ê¸¸ì´ ê³„ì‚°</button>

  <div class="result" id="result"></div>

  <script type="module">
    import * as poseDetection from 'https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.0.0/dist/pose-detection.min.js';
    import * as tf from 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0/dist/tf.min.js';
    import 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@3.9.0/dist/tf-backend-webgl.min.js';


    const video = document.getElementById('video');
    const resultDiv = document.getElementById('result');

    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      return new Promise(resolve => video.onloadedmetadata = resolve);
    }

    function getAngle(a, b, c) {
      const ab = [a.x - b.x, a.y - b.y];
      const cb = [c.x - b.x, c.y - b.y];
      const dot = ab[0]*cb[0] + ab[1]*cb[1];
      const magA = Math.hypot(...ab);
      const magC = Math.hypot(...cb);
      return (Math.acos(dot / (magA * magC)) * 180) / Math.PI;
    }

    function calculateStrapLength(angle, tilt, height, weight, bagWeight) {
      const L_max = height * 0.40;
      const L_min = height * 0.25;
      const k_weight = height * 0.01;
      const k_posture = height * 0.005;

      const posture_penalty = angle / 30.0;
      const tilt_penalty = tilt / 15.0;
      const total_penalty = (bagWeight * k_weight) + (posture_penalty + tilt_penalty) * k_posture;

      const strapLength = Math.max(L_min, Math.min(L_max, L_max - total_penalty));
      return strapLength.toFixed(1);
    }

    async function analyze() {
      const detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet);
      const poses = await detector.estimatePoses(video);
      if (!poses.length) {
        resultDiv.textContent = "ìì„¸ ì¸ì‹ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        return;
      }

      const keypoints = poses[0].keypoints;
      const ls = keypoints.find(k => k.name === "left_shoulder");
      const rs = keypoints.find(k => k.name === "right_shoulder");
      const lh = keypoints.find(k => k.name === "left_hip");
      const lk = keypoints.find(k => k.name === "left_knee");

      if (!ls || !rs || !lh || !lk) {
        resultDiv.textContent = "ìì„¸ ì¸ì‹ì´ ì •í™•í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        return;
      }

      const angle = getAngle(ls, lh, lk);
      const tilt = Math.abs(ls.y - rs.y) * 100;

      const height = +document.getElementById('height').value;
      const weight = +document.getElementById('weight').value;
      const bagWeight = +document.getElementById('bagWeight').value;

      const length = calculateStrapLength(angle, tilt, height, weight, bagWeight);
      resultDiv.textContent = `ì¶”ì²œ ê°€ë°©ëˆ ê¸¸ì´: ${length} cm`;
    }

    await setupCamera();
  </script>
</body>
</html>
